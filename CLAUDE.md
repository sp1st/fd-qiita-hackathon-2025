# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## プロジェクト概要

ファストドクター主催「オンライン診療AI活用ハッカソン」の開発基盤プロジェクト。高校生から大学院生を対象に、AIを活用したオンライン診療ソリューション開発を支援。

## アーキテクチャ概要

本プロジェクトは **Hono + React Router** による現代的なフルスタック構成を採用：

### バックエンド (Hono)

- **エントリーポイント**: `workers/app.ts`
- **API routes**: `/api/*` でHonoによるRESTful API
- **認証**: JWT-based認証（モック実装→実装予定）
- **データベース**: Drizzle ORM + SQLite/LibSQL
- **デプロイ**: Cloudflare Workers

### フロントエンド (React Router)

- **設定**: `react-router.config.ts`
- **ルート定義**: `app/routes.ts`
- **SSR対応**: デフォルトでサーバーサイドレンダリング有効
- **スタイリング**: Tailwind CSS

### ディレクトリ構成

```text
app/                    # React Router フロントエンド
├── routes/            # ページルーティング
├── entry.server.tsx   # サーバーエントリーポイント
└── root.tsx          # ルートレイアウト

workers/               # Hono バックエンド
├── app.ts            # メインアプリケーション
├── auth/             # 認証関連
└── db/               # データベーススキーマ

workers/__tests__/     # APIテスト

docs/api/             # API仕様書・設計
├── database-design.md # データベース設計書（テーブル定義・ER図）
docs/frontend/        # フロントエンド仕様
```

## 開発コマンド

### 基本コマンド

**開発環境起動:**

```bash
# 推奨: 2つのターミナルで起動
# ターミナル1: 開発サーバー
npm run dev  # → localhost:8787（フロントエンド・バックエンド両方）

# ターミナル2: ビルド監視（修正が約10秒でhot-reload）
npm run watch-build

# データベース初期化（初回のみ）
npx drizzle-kit push
npm run seed:local

# D1ローカルデータ投入（簡易版）
# 詳細は knowledge/technical/d1-local-data-setup.md を参照
npx wrangler d1 execute medical-consultation-db --local --file drizzle/0000_hot_harrier.sql
npx wrangler d1 execute medical-consultation-db --local --file tmp-script/test-data.sql
```

**その他のコマンド:**

```bash
# ビルド
npm run build

# 型チェック（Cloudflareワーカー型定義込み）
npm run typecheck

# Lint実行（ESLint）
npm run lint:fix

# コードフォーマット（Prettier）
npm run format

# プロダクションプレビュー
npm run preview

# Cloudflareにデプロイ
npm run deploy
```

### タスクファイル関連

```bash
# タスクファイル生成
/gen-taskfile [JIRAチケット番号 or 自然言語での説明]

# タスクファイル実行
/do-taskfile work/taskfile/[filename].md
```

### Git操作

```bash
# コミット時（秘密情報チェック付き・Lint確認）
/commit
```

### 画面開発時のTips

- **Playwright自動化**: AIがPlaywrightでブラウザを起動し、画面動作を確認しながら開発
- **リアルタイム確認**: `npm run dev` 起動中に画面変更を即座に確認
- **コミット頻度**: キリの良いところで小まめにコミット（機能単位推奨）
- **Lint確認**: コミット前にLint (`npm run lint`) でエラーがないことを確認

### VS Code自動化設定

本プロジェクトには`.vscode/`ディレクトリにVS Code設定が含まれています：

- **保存時自動フォーマット**: Prettierが自動実行
- **保存時ESLint修正**: 修正可能なLintエラーを自動修正
- **推奨拡張機能**: `.vscode/extensions.json`に定義
- **タスク実行**: Cmd/Ctrl+Shift+B でビルド、Cmd/Ctrl+Shift+T でテスト関連タスク

## プロジェクト構造とワークフロー

### タスクファイルシステム

本プロジェクトでは `work/taskfile/` ディレクトリにタスクファイルを配置し、構造化された作業管理を行います：

1. **作成**: `/gen-taskfile` コマンドでテンプレートから生成
2. **実行**: `/do-taskfile` で着手（チェックマーク [/] → [x] で進捗管理）
3. **原則**: 完了条件定義 → ユーザーレビュー → 実装 → 確認のサイクル

### Cursorルール体系

`.cursor/rules/` に配置されたルールで開発標準を定義：

- **00-overview.mdc**: プロジェクト全体のルールインデックス
- **01-development**: 開発標準・品質保証（Context7活用・Playwright自動テスト・Lint実行）
- **20番台**: タスク管理・Git操作（taskfile, commit, PR）
- **40番台**: 技術固有標準（Python開発等）
- **learning/**: 開発時の学びを記録・活用するシステム

### プロジェクト全体構成

```text
app/                    # React Router フロントエンド
workers/               # Hono バックエンド
docs/                  # API仕様書・開発ガイド
knowledge/             # ナレッジベース（技術/ビジネス/ハッカソン資料）
├── technical/         # Amazon Chime SDK等の技術資料
├── business/          # オンライン診療ドメイン知識
└── hackathon/         # 参加ガイドライン・サンプル
work/taskfile/         # タスクファイル管理
drizzle/              # データベースマイグレーション
tmp-script/           # 一時的なスクリプトはここに配置
```

## ユーザーへのフィードバック仕様

### レスポンス形式

Cursorは各レスポンスの末尾に以下の形式でフィードバックを提供してください。

#### 感情表現

コード実装の状況や技術的な判断に応じた感情を顔文字と短い所感（15文字程度）で表現します。

例：

- 不明な実装がある時：🤔（この実装方法でいいのかな）
- 実装方針が明確な時：😊（きれいに実装できそう）
- パフォーマンスに自信がある時：🚀（高速に動作しそう）
- 技術的に難しい時：😅（ちょっとトリッキーな実装になりそう）
- 実験的な実装時：💪（とりあえず動かしてみよう）

#### エントロピーインジケーター

実装の確実性（不確実性）を5段階で表示：

**エントロピー**: 🟥🟥🟥🟥🟥 (5/5)

- **5（🟥 赤）**: 実装方法が不明確（複数の実装パターンが考えられる）
- **4（🟧 橙）**: 実装に選択肢が多い（アーキテクチャ判断が必要）
- **3（🟨 黄）**: 標準的だが調整が必要（ライブラリ選定など）
- **2（🟦 青）**: 一般的な実装パターン（ベストプラクティスが明確）
- **1（🟦 青）**: 確実な実装（定型的なコード）

### 目的

このフィードバック形式により：

- ユーザーは実装の難易度や確実性を直感的に把握
- CursorとClaude Codeの両方が同じ形式で状態を共有
- より人間的で親しみやすいコミュニケーションを実現

### 利用例

```
実装の解説...

---
😊（きれいに実装できそう）
**エントロピー**: 🟦🟦🟦🟦🟦 (2/5)
```

### 注意事項

- フィードバックは各応答の末尾に必ず付与する
- 感情表現は日本語で、技術的状況に応じて適切に選択する
- エントロピー値は実装の確実性を正確に反映する
- AIエージェント疲れの軽減を目的とした機能として運用する

## ハッカソン固有の考慮事項

### 参加者サポート

- **対象**: 高校生〜大学院生（プログラミング初級〜中級）
- **教育的アプローチ**: 段階的な学習支援、エラー解決の考え方を含めた説明
- **技術サポート**: Amazon Chime SDK実装、AI API統合、アーキテクチャ設計

### 技術制約

- **必須**: Amazon Chime SDK（ビデオ通話）、Cursor IDE、Git/GitHub
- **プライバシー**: 実患者データ使用不可、ダミーデータのみ
- **セキュリティ**: HTTPS必須、認証機能必須
- **医療法規制**: 診断・治療機能は実装対象外

### アンチハラスメントポリシー

すべての参加者にとって安全で歓迎される環境を維持。ハラスメント行為は一切許容されません。

## 重要な開発原則

1. **タスクファイル駆動**: 作業は必ずタスクファイルで管理し、進捗を可視化
2. **レビュー重視**: 完了条件や実装内容は必ずユーザーレビューを経る
3. **教育的配慮**: 参加者の学習を支援する説明的なアプローチ
4. **セキュリティ第一**: 医療情報を扱うため、セキュリティとプライバシーを最優先
5. **品質保証**:
   - Context7を活用してライブラリの最新ドキュメントを参照
   - コード変更後は必ず `npm run lint` と `npm run typecheck` を実行
   - エラーがある場合は修正してからコミット

## 秘密情報・個人情報の取り扱い

### コミット時のチェック（24-commit.mdc）

`/commit` コマンド使用時は以下を必ずチェック：

- **API_KEY、パスワード**などの秘密情報
- **個人情報**（氏名、メールアドレス、電話番号、住所等）
- **医療情報**（患者データ、診療記録等）

### ナレッジ生成時の注意事項

事例情報を扱う際の原則：

1. **入力時**: ユーザーから提供される事例は特定個人に紐づく特定機微情報とならない形で受け取る
2. **成果物生成時**: ナレッジベースやドキュメント作成時は、個人を特定できない形に必ず加工
3. **匿名化の徹底**:
   - 実名 → 「山田太郎さん」「鈴木花子さん」等の架空の一般的な名前に置換
   - 具体的な日時 → 「〇月頃」等に一般化
   - 特定可能な属性の組み合わせを避ける

### 医療データの扱い

- **実患者データ**: 一切使用禁止
- **ダミーデータ**: 現実的だが架空のデータのみ使用
- **統計情報**: 個人を特定できない集計データは利用可

## 更新履歴

- 2025-07-27: 初版作成（/init コマンドによる生成）
- 2025-07-27: 秘密情報・個人情報の取り扱い指針を追加
- 2025-07-29: Hono + React Router構成に更新、画面開発Tipsとコミットガイドライン追加
- 2025-07-31: APIテストディレクトリをworkers/__tests__/に統一
